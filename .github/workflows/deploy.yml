name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

          sshpass -p "Amaury262879?" ssh -o StrictHostKeyChecking=no ubuntu@37.59.106.113 << 'ENDSSH'
            set -e

            echo "=== Setting up application directory ==="
            sudo mkdir -p /var/www/thot-backend
            sudo chown -R ubuntu:ubuntu /var/www/thot-backend
            cd /var/www/thot-backend

            if [ ! -d ".git" ]; then
              echo "=== Cloning repository ==="
              git clone https://github.com/${{ github.repository }} .
            else
              echo "=== Pulling latest changes ==="
              git fetch origin
              git reset --hard origin/main
            fi

            echo "=== Installing Node.js if needed ==="
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -
              sudo apt-get install -y nodejs
            fi

            echo "=== Installing PM2 if needed ==="
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            echo "=== Installing dependencies ==="
            npm ci --production

            echo "=== Creating .env file ==="
            cat > .env << 'EOF'
          NODE_ENV=production
          PORT=3000
          MONGO_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          S3_ACCESS_KEY_ID=3362f96514e14af38a9710cb60c5fff1
          S3_SECRET_ACCESS_KEY=79a7bc7abc5940f29e6bf01afb32d3a0
          S3_REGION=rbx
          S3_ENDPOINT=https://s3.rbx.io.cloud.ovh.net
          S3_BUCKET_NAME=thot-3sd
          API_BASE_URL=http://37.59.106.113:3000
          CLIENT_URL=http://37.59.106.113:3000
          EOF

            echo "=== Setting up PM2 ecosystem ==="
            cat > ecosystem.config.js << 'EOFPM2'
          module.exports = {
            apps: [{
              name: 'thot-backend',
              script: './src/server.js',
              instances: 1,
              exec_mode: 'cluster',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              },
              error_file: './logs/err.log',
              out_file: './logs/out.log',
              log_file: './logs/combined.log',
              time: true
            }]
          };
          EOFPM2

            echo "=== Creating logs directory ==="
            mkdir -p logs

            echo "=== Restarting application ==="
            pm2 delete thot-backend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            pm2 startup systemd -u ubuntu --hp /home/ubuntu

            echo "=== Installing and configuring Nginx ==="
            if ! command -v nginx &> /dev/null; then
              sudo apt-get install -y nginx
            fi

            sudo bash -c 'cat > /etc/nginx/sites-available/thot-backend' << 'EOFNGINX'
          server {
              listen 80;
              server_name 37.59.106.113;

              client_max_body_size 500M;

              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;

                  proxy_connect_timeout 600;
                  proxy_send_timeout 600;
                  proxy_read_timeout 600;
                  send_timeout 600;
              }
          }
          EOFNGINX

            sudo ln -sf /etc/nginx/sites-available/thot-backend /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl restart nginx

            echo "=== Opening firewall ports ==="
            sudo ufw allow 80/tcp 2>/dev/null || true
            sudo ufw allow 3000/tcp 2>/dev/null || true

            echo "=== Deployment completed ==="
            pm2 status

            echo "=== Health check ==="
            sleep 5
            curl -f http://localhost:3000/api/health || echo "Health check endpoint not available"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
            echo "Backend is now running at http://37.59.106.113"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
